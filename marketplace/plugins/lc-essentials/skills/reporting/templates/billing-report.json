{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "name": "billing-report",
  "description": "Invoice-focused billing report for single tenant or all tenants",
  "version": "1.0",
  "input": {
    "required": {
      "year": {
        "type": "integer",
        "description": "Invoice year (e.g., 2025)",
        "minimum": 2020,
        "maximum": 2100
      },
      "month": {
        "type": "integer",
        "description": "Invoice month (1-12)",
        "minimum": 1,
        "maximum": 12
      }
    },
    "optional": {
      "scope": {
        "type": "string",
        "enum": ["single", "all"],
        "default": "all",
        "description": "single = one org (requires oid), all = all accessible orgs"
      },
      "oid": {
        "type": "string",
        "format": "uuid",
        "description": "Organization ID (required when scope=single)"
      },
      "format": {
        "type": "string",
        "enum": ["json", "markdown"],
        "default": "markdown",
        "description": "Output format"
      }
    }
  },
  "output": {
    "type": "object",
    "required": ["metadata", "data"],
    "properties": {
      "metadata": {
        "type": "object",
        "required": ["generated_at", "period", "scope"],
        "properties": {
          "generated_at": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp when report was generated"
          },
          "period": {
            "type": "string",
            "description": "Human-readable billing period (e.g., 'November 2025')"
          },
          "scope": {
            "type": "string",
            "enum": ["single", "all"],
            "description": "Report scope"
          },
          "tenant_count": {
            "type": "integer",
            "description": "Number of tenants in report (when scope=all)"
          }
        }
      },
      "data": {
        "type": "object",
        "required": ["tenants"],
        "properties": {
          "tenants": {
            "type": "array",
            "description": "Per-tenant billing data",
            "items": {
              "type": "object",
              "required": ["name", "oid", "status"],
              "properties": {
                "name": {
                  "type": "string",
                  "description": "Organization name"
                },
                "oid": {
                  "type": "string",
                  "format": "uuid",
                  "description": "Organization ID"
                },
                "status": {
                  "type": "string",
                  "enum": ["success", "error", "no_invoice"],
                  "description": "Data collection status"
                },
                "cost": {
                  "type": "number",
                  "description": "Total invoice amount in dollars (converted from cents)"
                },
                "currency": {
                  "type": "string",
                  "default": "usd",
                  "description": "Currency code"
                },
                "skus": {
                  "type": "array",
                  "description": "Invoice line items",
                  "items": {
                    "type": "object",
                    "required": ["description", "amount"],
                    "properties": {
                      "description": {
                        "type": "string",
                        "description": "Line item description"
                      },
                      "amount": {
                        "type": "number",
                        "description": "Amount in dollars"
                      },
                      "quantity": {
                        "type": ["string", "number"],
                        "description": "Quantity or unit"
                      }
                    }
                  }
                },
                "invoice_url": {
                  "type": "string",
                  "format": "uri",
                  "description": "PDF download URL (expires)"
                },
                "error_message": {
                  "type": "string",
                  "description": "Error details if status=error"
                }
              }
            }
          },
          "rollup": {
            "type": "object",
            "description": "Aggregate totals (only when scope=all)",
            "properties": {
              "total_cost": {
                "type": "number",
                "description": "Sum of all tenant costs in dollars"
              },
              "total_tenants": {
                "type": "integer",
                "description": "Total number of tenants processed"
              },
              "successful_count": {
                "type": "integer",
                "description": "Tenants with successful data retrieval"
              },
              "failed_count": {
                "type": "integer",
                "description": "Tenants that failed or had no invoice"
              }
            }
          }
        }
      },
      "warnings": {
        "type": "array",
        "items": {
          "type": "string"
        },
        "description": "Warning messages"
      },
      "errors": {
        "type": "array",
        "items": {
          "type": "object",
          "properties": {
            "org_name": {
              "type": "string"
            },
            "oid": {
              "type": "string"
            },
            "error_message": {
              "type": "string"
            }
          }
        },
        "description": "Detailed error information per failed org"
      }
    }
  },
  "data_sources": {
    "description": "API calls used to populate this template (documentation only)",
    "primary": {
      "function": "get_org_invoice_url",
      "parameters": {
        "oid": "from input or list_user_orgs",
        "year": "from input",
        "month": "from input",
        "format": "simple_json"
      },
      "notes": "Amounts returned in cents - divide by 100 for dollars"
    },
    "supporting": {
      "function": "list_user_orgs",
      "parameters": {},
      "notes": "Used to get OID list when scope=all"
    }
  }
}
