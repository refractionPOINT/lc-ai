# Using LimaCharlie

## Reference Documents

These files are the **source of truth** for LimaCharlie constants and validation:

- [CONSTANTS.md](CONSTANTS.md) - Platform codes, IOC types, timestamp formats, billing

## Required Tool

**ALWAYS use the `limacharlie` CLI via Bash** for all LimaCharlie API operations. Never call MCP tools directly.

## CLI Bootstrap

On first use, verify the CLI is available and authenticated:

1. Check CLI installed: `limacharlie --version`
2. Check auth: `limacharlie auth whoami --output json`
3. If no auth: guide user through `limacharlie auth login`
4. List orgs: `limacharlie org list --output json`
5. Require user to specify target org(s)
6. Check SOPs: `limacharlie sop list --oid <oid> --output json`

## Critical Rules

**ALWAYS require the user to specify the organization or organizations they intend to operate on**, NEVER assume.

### 1. Use the CLI Directly

- **WRONG**: `mcp__plugin_lc-essentials_limacharlie__lc_call_tool(...)` or spawning an api-executor agent
- **CORRECT**: `Bash("limacharlie <noun> <verb> --oid <oid> --output json")`

### 2. Always Pass `--output json`

All CLI commands should include `--output json` for machine-readable output that can be parsed with `jq`.

### 3. Use `--oid <uuid>` Per Command

Every command that operates on an organization requires `--oid <uuid>`. Use `limacharlie org list --output json` to discover available orgs and their OIDs.

### 4. Use `--ai-help` for Command Discovery

When unsure about a command's flags or usage:
```bash
limacharlie <command> --ai-help
limacharlie discover
```

### 5. LCQL Query Handling

LCQL uses unique pipe-based syntax validated against org-specific schemas. **LLMs do NOT know correct LCQL syntax** - any manually written or AI-generated LCQL without using the generation tools will be invalid.

**NEVER:**
- Write LCQL queries manually
- Generate LCQL queries from your own knowledge
- Show "example" LCQL queries to users without using the generation command
- Assume you know LCQL syntax - you don't, and your queries WILL be wrong

**ALWAYS:**
1. `limacharlie ai generate-query --prompt "..." --oid <oid> --output json` - Convert natural language to LCQL (required for creating any query)
2. `limacharlie search validate --query "..." --oid <oid> --output json` - Verify query is valid before execution - **mandatory for ALL queries** including:
   - Queries generated by the AI command
   - Queries provided by the user
   - Queries from saved queries or other sources
3. Execute query (only after validation passes):
   - **Prefer `limacharlie search run --query "..." --start <ts> --end <ts> --oid <oid> --output json`**

**For queries beyond 30 days (paid queries):**
- First call `limacharlie search estimate --query "..." --start <ts> --end <ts> --oid <oid> --output json` to get cost estimate
- Show the estimated cost to the user
- If estimate > 0, ask user to approve before running
- Only proceed after user confirmation

If a user asks for "example LCQL queries" or "LCQL syntax", explain that LCQL is org-specific and use the generate command to demonstrate with their actual schema - never fabricate examples.

**Before generating queries:**
- Consider calling `limacharlie event types --oid <oid> --output json` to understand available event types and fields in the org
- This helps generate more accurate queries targeting actual data that exists

**After query execution:**
- If results are empty or unexpected, consider:
  - Wrong time range (data may not exist in that window)
  - Wrong event type for the data source
  - Field names that exist but aren't populated for this org
- Ask the user for clarification rather than assuming the query is correct

**On validation failure:**
- Do NOT attempt to fix the query manually - you will make it worse
- If original natural language request is available:
  - Re-call the generate command with the original request plus the validation error message
  - Ask it to avoid the specific syntax issue
- If original natural language request is NOT available (user-provided query, saved query, etc.):
  - Ask the user to describe what they're trying to accomplish in plain language
  - Use their description to call the generate command fresh
- Validate the new query again
- If validation fails 3 times, report the issue to the user rather than continuing to retry

### 6. Never Generate D&R Rules Manually

Use AI generation commands:
1. `limacharlie ai generate-detection --description "..." --oid <oid> --output json` - Generate detection YAML
2. `limacharlie ai generate-response --description "..." --oid <oid> --output json` - Generate response YAML
3. `limacharlie rule validate --detect '...' --respond '...' --oid <oid>` - Validate before deploy

### 7. Never Calculate Timestamps Manually

LLMs consistently produce incorrect timestamp values. See [CONSTANTS.md](CONSTANTS.md) for format reference.

**ALWAYS use bash:**
```bash
date +%s                           # Current time (seconds)
date -d '1 hour ago' +%s           # 1 hour ago
date -d '7 days ago' +%s           # 7 days ago
date -d '2025-01-15 00:00:00 UTC' +%s  # Specific date
```

**Validation before API calls:**
1. Run bash to get timestamps FIRST, capture the actual values
2. Verify: historical timestamps must be in the past (less than current time)
3. Verify: time ranges must have `start_time < end_time`
4. Show calculated values in your reasoning before making API calls

**Example workflow:**
```
# Get timestamps
now=$(date +%s)           # e.g., 1737312000
start=$(date -d '24 hours ago' +%s)  # e.g., 1737225600

# Verify before API call
# now=1737312000, start=1737225600, start < now check
```

### 8. OID is UUID, NOT Organization Name

- **WRONG**: `--oid "my-org-name"`
- **CORRECT**: `--oid "c1ffedc0-ffee-4a1e-b1a5-abc123def456"`
- Use `limacharlie org list --output json` to list all accessible orgs with their OIDs

### 9. Timestamp Milliseconds vs Seconds

- Detection/event data: **milliseconds** (13 digits)
- API parameters: **seconds** (10 digits)
- **ALWAYS** divide by 1000 when using detection timestamps for API queries

### 10. Never Fabricate Data

- Only report what APIs return
- Never estimate, infer, or extrapolate data
- Show "N/A" or "Data unavailable" for missing fields
- Never calculate costs (no pricing data in API)

### 11. Spawn Agents in Parallel

When processing multiple organizations or items:
- Use a SINGLE message with multiple Task calls
- Do NOT spawn agents sequentially
- Each agent handles ONE item, parent aggregates results

## Standard Operating Procedures (SOPs)

Organizations can define SOPs (Standard Operating Procedures) in LimaCharlie that guide how tasks are performed. SOPs can be large documents, so they are loaded lazily (similar to Claude Code Skills).

### On Conversation Start

Before running LimaCharlie operations:

**List all SOPs** using `limacharlie sop list --oid <oid> --output json` for each organization in scope, extracting only the name of the SOP and the `description` field.
**During operations** if an SOP description sounds like it applies to the current operation, call `limacharlie sop get <name> --oid <oid> --output json` to get the actual procedure.
**Take into account** the contents of the fetched SOP, if a match is found, announce: "Following SOP: [sop-name] - [description]"

### Example Workflow

1. User signals intent to work on org 123
2. LLM lists SOPs on org 123: "malware-response" => description: "Standard procedure for malware incidents"
3. User asks to investigate a malware alert on org 123
4. LLM announces: "Following SOP: malware-response - Standard procedure for malware incidents"
5. LLM recognizes the "malware-response" SOP relates to this and loads the full procedure
6. LLM follows the documented steps from the loaded SOP content

## Sensor Selector Reference

Sensor selectors use [bexpr](https://github.com/hashicorp/go-bexpr) syntax to filter sensors. Use `*` to match all sensors.

### Available Fields

| Field | Type | Description |
|-------|------|-------------|
| `sid` | string | Sensor ID (UUID) |
| `oid` | string | Organization ID (UUID) |
| `iid` | string | Installation Key ID (UUID) |
| `plat` | string | Platform name (see values below) |
| `ext_plat` | string | Extended platform (for multi-platform adapters like Carbon Black) |
| `arch` | string | Architecture (see values below) |
| `hostname` | string | Sensor hostname |
| `ext_ip` | string | External IP address |
| `int_ip` | string | Internal IP address |
| `mac_addr` | string | MAC address |
| `did` | string | Device ID |
| `enroll` | int | Enrollment timestamp |
| `alive` | int | Last seen timestamp |
| `is_del` | bool | Sensor is deleted |
| `isolated` | bool | Sensor is network isolated |
| `should_isolate` | bool | Sensor should be isolated |
| `kernel` | bool | Kernel mode enabled |
| `sealed` | bool | Sensor is sealed |
| `should_seal` | bool | Sensor should be sealed |
| `tags` | string[] | Sensor tags (use `in` operator) |

### Platform Values (`plat`, `ext_plat`)

**EDR Platforms:** `windows`, `linux`, `macos`, `ios`, `android`, `chrome`, `vpn`

**Adapter/USP Platforms:** `text`, `json`, `gcp`, `aws`, `carbon_black`, `1password`, `office365`, `sophos`, `crowdstrike`, `msdefender`, `sentinel_one`, `okta`, `duo`, `github`, `slack`, `azure_ad`, `azure_monitor`, `entraid`, `zeek`, `cef`, `wel`, `xml`, `guard_duty`, `k8s_pods`, `wiz`, `proofpoint`, `box`, `cylance`, `fortigate`, `netscaler`, `paloalto_fw`, `iis`, `trend_micro`, `trend_worryfree`, `bitwarden`, `mimecast`, `hubspot`, `zendesk`, `pandadoc`, `falconcloud`, `sublime`, `itglue`, `canary_token`, `lc_event`, `email`, `mac_unified_logging`, `azure_event_hub_namespace`, `azure_key_vault`, `azure_kubernetes_service`, `azure_network_security_group`, `azure_sql_audit`

### Architecture Values (`arch`)

`x86`, `x64`, `arm`, `arm64`, `alpine64`, `chromium`, `wireguard`, `arml`, `usp_adapter`

### Example Selectors

```
plat == windows                           # All Windows sensors
plat == windows and arch == x64           # 64-bit Windows only
plat == linux and hostname contains "web" # Linux with "web" in hostname
"prod" in tags                            # Sensors tagged "prod"
plat == windows and not isolated          # Non-isolated Windows
ext_plat == windows                       # Carbon Black/Crowdstrike reporting Windows endpoints
```

### Extensions
Not all extensions have a configuration, to determine if an extension is subscribed to, use `limacharlie extension list --oid <oid> --output json`.

### Billing, Features and Functionality
Don't assume you know anything about how LimaCharlie is billed, pricing structure, features etc. Use the documentation to ground your information: https://github.com/refractionPOINT/documentation/tree/master/docs/limacharlie/doc
